#!/bin/sh

IN_DIR=$SRCDIR/test/performance
OUT_DIR=$CIRCLE_ARTIFACTS/


log()   { echo "$1" >&2 ;            }
fatal() { log "FATAL: $1" ; exit 1 ; }

###########################################################################

[ -n "$CIRCLE_ARTIFACTS" ] || fatal "no artifacts folder in environment"
[ -n "$PLOTLY_USERNAME" ]  || fatal "no PlotLy user name in environment"
[ -n "$PLOTLY_API_KEY" ]   || fatal "no PlotLy API key in environment"
[ -d $IN_DIR ]             || fatal "no performance directory found"
[ -d $OUT_DIR ]            || fatal "no output directory found"


log "Processing performance logs in $IN_DIR"
for csv_file in $IN_DIR/*.csv ; do
    [ -f $csv_file ] || continue
    
    name=$(basename $csv_file .csv)

    log "Generating graph for $name"
    $SRCDIR/bin/circleci/do-perf-graphs.py \
        --plot-username $PLOTLY_USERNAME \
        --plot-key $PLOTLY_API_KEY \
        --plot-name $name \
        --num 5 \
        --plot-save-to $OUT_DIR/$name.png \
        --pattern $(basename $csv_file) \
        --num $PERF_GRAPH_HISTORY "$csv_file"
        
    log "Copying CSV file"
    cp $csv_file $OUT_DIR/
done

